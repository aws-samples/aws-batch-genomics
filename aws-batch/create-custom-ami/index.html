<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Angel Pizarro <pizarroa@amazon.com>">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Creating a custom AMI - AWS for Genomics Workflows</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Creating a custom AMI";
    var mkdocs_page_input_path = "aws-batch/create-custom-ami.md";
    var mkdocs_page_url = "/aws-batch/create-custom-ami/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> AWS for Genomics Workflows</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setting up AWS Batch</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../configure-aws-batch-start/">Getting Started</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Creating a custom AMI</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#custom-aws-batch-compute-resources-for-genomics">Custom AWS Batch compute resources for genomics</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#create-a-custom-ami">Create a custom AMI</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Configuring AWS Batch with CloudFormation</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../configure-aws-batch-cfn/">Launch the CloudFormation stacks</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../notes-vpc/">Notes on Amazon VPC</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../notes-iam/">Notes on IAM Permissions</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setting up a genomics workflow environment</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../genomics-workflows-intro/">Introduction</a>
                </li>
                <li class="">
                    
    <span class="caption-text">AWS Step Functions</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../step-functions/intro-step-functions/">Introduction and requirements</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../step-functions/create-batchjobrunner-container/">Creating a job management container</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../step-functions/create-example-sfl-workflow/">An example workflow</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../../cromwell/cromwell-aws-batch/">Cromwell</a>
                </li>
                <li class="">
                    
    <a class="" href="../../nextflow/nextflow-aws-batch/">Nextflow</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">AWS for Genomics Workflows</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Setting up AWS Batch &raquo;</li>
        
      
    
    <li>Creating a custom AMI</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/aws-samples/aws-batch-genomics/edit/master/docs/aws-batch/create-custom-ami.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="custom-aws-batch-compute-resources-for-genomics">Custom AWS Batch compute resources for genomics</h1>
<p>A default AWS Batch environment assumes that the storage available to the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html">Amazon ECS-Optimized AMI</a> meets the needs of most customers. Any other needs, such as the large scratch storage requirements noted above, or devices like GPUs, can be handled by providing AWS Batch with a custom <a href="https://docs.aws.amazon.com/batch/latest/userguide/compute_resource_AMIs.html">Compute Resource AMI</a>.</p>
<p>Genomics is a data-heavy workload and requires some modification to the standard AWS Batch processing environment. In particular, we need the underlying instance storage that tasks (<a href="https://docs.aws.amazon.com/batch/latest/userguide/jobs.html">AWS Batch Jobs</a>) run on top of to meet unpredictable runtime demands.</p>
<p>We have provided a script (see <a href="#create-a-custom-ami">the next section</a>) that customizes the ECS-Optimized AMI to add a working directory that the Jobs will use to write data. That directory will be monitored by a process that inspects the free space available and adds more EBS volumes and expands the filesystem on the fly, like so:</p>
<p><img alt="Autoscaling EBS storage" src="../images/autoscale-ebs.gif" /></p>
<h2 id="create-a-custom-ami">Create a custom AMI</h2>
<p>We have provided a Python script that sets up the above.</p>
<p>The script will:</p>
<ol>
<li>Launch an EC2 instance from the ECS-Optimized AMI with a encrypted EBS volumes for the Docker containers  and scratch space</li>
<li>Adjust the system settings to mount the scratch on instance start.</li>
<li>Install and configure a small service to monitor and automatically expand the scratch space by adding new EBS volume</li>
<li>Make the necessary adjustments to the Amazon Elastic Container Service (ECS) agent to work with AWS Batch</li>
<li>Adjust the network settings to allow for containers to query instance metadata for their Task IAM roles.</li>
</ol>
<pre><code class="bash"># Download the script and install the requirements
curl -O https://raw.githubusercontent.com/aws-samples/aws-batch-genomics/master/src/custom-ami/create-custom-ami.py
pip install boto3

# Run the script to see the help
python create-custom-ami.py --help
# Output:
# No default VPC found. You must provide *both* VPC and Subnet IDs that are able to access public IP domains on CLI
# usage: create-genomics-ami.py [-h] [--scratch_mount_point SCRATCH_MOUNT_POINT]
#                               [--key-pair-name KEY_PAIR_NAME]
#                               [--vpc-id VPC_ID] [--subnet-id SUBNET_ID]
#                               [--security-group-id SECURITY_GROUP_ID]
#                               [--terminate-instance] [--no-terminate-instance]
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are unable to leverage this script, you likely don't have the permissions to work in this enviroment. Talk with your account administrator and show them this guide.</p>
</div>
<p>The <code>--key-pair-name</code> parameter defaults to <code>"genomics-ami"</code>. The script will create the key pair if it does not exist and write out a PEM file (<code>genomics-ami.pem</code>) to the same directory as where you ran the script. If the key pair already exists, we assume that you know how to find it for your use.</p>
<p>By default, the script terminates the new instance. If you want to leave the instance up to SSH into and review, provice the <code>--no-terminate-instance</code> argument.</p>
<p>Most new accounts have a <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html">default VPC</a>, but if this is not the case, or if you want to leverage a non-default VPC, then supply <strong>both</strong> the <code>--vpc-id</code> and <code>--subnet-id</code> parameters.</p>
<p>The script takes about 10 minutes to run, you may want to take a <img alt="â˜•" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/3.1/png/64/2615.png" title=":coffee:" /> or <img alt="ðŸµ" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/3.1/png/64/1f375.png" title=":tea:" />  break at this point. Here is an example of the output from running the script (<em>values for ID's have been changed</em>):</p>
<pre><code class="shell">Getting the security group from name GenomicsAmiSG-subnet-123ab123
Security Group GenomicsAmiSG-subnet-123ab123 does not exist. Creating.
Key Pair genomics-ami-west2 does not exist. Creating.
Key Pair PEM file written to  genomics-ami-west2.pem
Launching a new EC2 instance.
Waiting on instance to have a IP...[ 111.222.111.222 ].
Waiting on instance to pass health checks.................................instance available and healthy.
Minting a new AMI...........................new AMI [ami-123abc123] created.
Terminating instance...terminated.

Resources that were created on your behalf:

    * EC2 Key Pair: genomics-ami-west2
    * EC2 Security Group: sg-12ab1234
    * EC2 Instance ID: i-01234abcde2134
    * EC2 AMI ImageId: ami-123abc123

Take note the returned EC2 AMI ImageId. We will use that for the AWS Batch setup.

</code></pre>

<p>Once the script completes, you have a new AMI ID to give to AWS Batch. Make a note of the AMI ID that was returned, we will need it for future sections. If you chose to not terminate the instance,  you can also SSH into the server to review the services. Be sure to terminate the instance after you are done. Here is an example using the AWS CLI.</p>
<pre><code class="bash">aws ec2 terminate-instances --instance-ids i-01234abcde2134
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../configure-aws-batch-cfn/" class="btn btn-neutral float-right" title="Launch the CloudFormation stacks">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../configure-aws-batch-start/" class="btn btn-neutral" title="Getting Started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>2018 Amazon Web Services</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/aws-samples/aws-batch-genomics/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../configure-aws-batch-start/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../configure-aws-batch-cfn/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>

</body>
</html>
